---
### Note: Much of this might be simplified with the github api to determine the release download url
- name: Get terraform version
  shell: curl https://github.com/hashicorp/terraform/releases/latest   | grep -Po 'tag/v\K[^"]+' 
  changed_when: false
  register: terraform_version
- name: Download terraform binary
  get_url:
    url: "https://releases.hashicorp.com/terraform/{{ terraform_version.stdout }}/terraform_{{ terraform_version.stdout }}_linux_amd64.zip"
    dest: /tmp/tf.zip
    mode: 0777

#- name: Download terraform binary ## Hardcoding to 0.11 for now
#  get_url:
#    url: https://github.com/hashicorp/terraform/archive/v0.11.14.zip
#    dest: /tmp/tf.zip
#    mode: 0777
- name: unzip terraform binary
  unarchive: 
    src: /tmp/tf.zip
    dest: /usr/local/bin/
  become: yes
- name: set perms on terraform
  file:
    path: "/usr/local/bin/terraform"
    owner: root
    group: bin
    mode: 0755
  become: yes
#- name: create terraform link
#  file:
#    src: '/usr/local/bin/terraform-{{ terraform_version.stdout }}'
#    dest: '/usr/local/bin/terraform'
#    state: link
#  become: yes
# - name: Get vault version
#   shell: curl https://github.com/hashicorp/vault/releases/latest   | grep -Po 'tag/v\K[^"]+' 
#   register: vault_version
- name: Download vault binary
  get_url:
    url: https://releases.hashicorp.com/vault/1.2.3/vault_1.2.3_linux_amd64.zip
    dest: /tmp/vault.zip
    mode: 0777
- name: unzip vault binary
  unarchive: 
    src: /tmp/vault.zip
    remote_src: yes
    dest: /usr/local/bin/
    owner: root
    group: bin
    mode: 0755
  become: yes

- name: Install aws shell
  command: pip install aws-shell
  become: true

- name: Get operator_sdk version
  shell: curl https://github.com/operator-framework/operator-sdk/releases/latest   | grep -Po 'tag/v\K[^"]+' 
  changed_when: false
  register: operator_sdk_version
- name: Download operator-sdk binary
  get_url:
    url: https://github.com/operator-framework/operator-sdk/releases/download/v{{ operator_sdk_version.stdout }}/operator-sdk-v{{ operator_sdk_version.stdout }}-x86_64-linux-gnu
    dest: /usr/local/bin/operator-sdk
    mode: 0755
  become: yes

- name: Get helm version
  shell: curl https://github.com/helm/helm/releases/latest   | grep -Po 'tag/v\K[^"]+' 
  changed_when: false
  register: helm_version
#- name: Get helm download URL
#  shell: curl https://github.com/helm/helm/releases/tag/v"{{ helm_version.stdout }}" | grep "{{ helm_version.stdout }}" | grep linux-amd64.tar.gz | grep href | grep googleapis | awk -F "\"" '{print $2}'
#  register: helm_download_url
- name: Download helm binary
  get_url:
    url: "https://get.helm.sh/helm-v{{ helm_version.stdout }}-linux-amd64.tar.gz"
    dest: /tmp/helm.tar.gz
    mode: 0777
- name: unzip helm binary
  unarchive: 
    src: /tmp/helm.tar.gz
    dest: /tmp
    extra_opts: [--strip-components=1]
    exclude:
      - LICENSE
      - tiller
      - README.md
- name: Get oc version
  shell: curl https://github.com/openshift/origin/releases/latest   | grep -Po 'tag/v\K[^"]+'
  changed_when: false
  register: oc_version
- name: Get oc download URL
  shell: curl https://github.com/openshift/origin/releases/tag/v"{{ oc_version.stdout }}" | grep "{{ oc_version.stdout }}" | grep linux-64bit.tar.gz | grep href | grep openshift-origin-client-tools | awk -F "\"" '{print $2}'
  changed_when: false
  register: oc_download_url
- name: Download oc binary
  get_url:
    url: "https://github.com/{{ oc_download_url.stdout }}"
    dest: /tmp/oc.tar.gz
    mode: 0777
- name: unzip oc binary
  unarchive: 
    src: /tmp/oc.tar.gz
    dest: /tmp
    extra_opts: [--strip-components=1]
  become: yes
- name: move binaries file
  copy:
    remote_src: yes
    src: "/tmp/{{ item }}"
    dest: "/usr/local/bin/{{ item }}"
    owner: root
    group: bin
    mode: 0755
  become: yes
  with_items: 
    - oc
    - helm
